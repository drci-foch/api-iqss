<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Rapports Lettres de Liaison ‚Äì H√¥pital Foch</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    :root {
      --foch-blue-dark: #003f72;
      --foch-blue: #005c99;
      --foch-blue-light: #e6f0f8;
      --foch-accent: #00a0a8;
      --foch-danger: #c62828;
      --bg-body: #f5f7fb;
      --text-main: #1f2933;
      --text-muted: #6b7280;
      --radius-lg: 16px;
      --shadow-soft: 0 18px 45px rgba(15, 23, 42, 0.18);
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        Roboto, sans-serif;
    }

    body {
      min-height: 100vh;
      background: radial-gradient(circle at top left, #f0f6ff, #f5f7fb 55%, #e9f2ff);
      color: var(--text-main);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 24px;
    }

    .app-shell {
      width: 100%;
      max-width: 1000px;
      background: #ffffff;
      border-radius: 24px;
      box-shadow: var(--shadow-soft);
      overflow: hidden;
      display: grid;
      grid-template-columns: minmax(0, 3fr) minmax(0, 2.2fr);
    }

    @media (max-width: 900px) {
      .app-shell {
        grid-template-columns: 1fr;
      }
    }

    .brand-panel {
      background: linear-gradient(145deg, var(--foch-blue-dark), var(--foch-blue));
      color: white;
      padding: 28px 32px;
      position: relative;
      overflow: hidden;
    }

    .brand-panel::before {
      content: "";
      position: absolute;
      inset: -80px;
      opacity: 0.16;
      background:
        radial-gradient(circle at 20% 0%, #ffffff 0, transparent 55%),
        radial-gradient(circle at 100% 100%, #ffffff 0, transparent 60%);
      pointer-events: none;
    }

    .brand-header {
      position: relative;
      display: flex;
      align-items: center;
      gap: 14px;
      margin-bottom: 22px;
    }

    .brand-logo {
      width: 42px;
      height: 42px;
      border-radius: 12px;
      background: rgba(255, 255, 255, 0.16);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 20px;
    }

    .brand-title-group {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .brand-title-group span:nth-child(1) {
      font-size: 13px;
      text-transform: uppercase;
      letter-spacing: 0.18em;
      opacity: 0.8;
    }

    .brand-title-group span:nth-child(2) {
      font-weight: 600;
      font-size: 20px;
    }

    .brand-subtitle {
      position: relative;
      font-size: 13px;
      line-height: 1.5;
      opacity: 0.9;
      margin-bottom: 26px;
    }

    .brand-badges {
      position: relative;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 18px;
    }

    .brand-badge {
      font-size: 11px;
      padding: 6px 10px;
      border-radius: 999px;
      background: rgba(255, 255, 255, 0.16);
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .brand-badge-dot {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: #38f3ff;
    }

    .brand-footer {
      position: relative;
      margin-top: 14px;
      font-size: 11px;
      opacity: 0.75;
    }

    .forms-panel {
      padding: 28px 30px 26px;
      background: #ffffff;
      display: flex;
      flex-direction: column;
      gap: 18px;
    }

    .forms-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }

    .forms-title {
      font-weight: 600;
      font-size: 18px;
    }

    .forms-subtitle {
      font-size: 13px;
      color: var(--text-muted);
    }

    .pill-switch {
      background: #f3f4f8;
      border-radius: 999px;
      padding: 3px;
      display: inline-flex;
      gap: 4px;
      border: 1px solid rgba(148, 163, 184, 0.4);
    }

    .pill-switch button {
      border: none;
      background: transparent;
      padding: 6px 12px;
      border-radius: 999px;
      font-size: 12px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 6px;
      color: var(--text-muted);
      transition: all 0.18s ease;
    }

    .pill-switch button.active {
      background: #ffffff;
      color: var(--foch-blue-dark);
      box-shadow: 0 1px 4px rgba(15, 23, 42, 0.18);
    }

    .pill-switch button span.icon {
      font-size: 14px;
    }

    .card {
      border-radius: var(--radius-lg);
      border: 1px solid #e0e7ff;
      padding: 18px 18px 16px;
      background: #ffffff;
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      margin-bottom: 10px;
    }

    .card-title {
      font-size: 15px;
      font-weight: 600;
    }

    .card-description {
      font-size: 12px;
      color: var(--text-muted);
      margin-bottom: 12px;
    }

    .field-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 12px;
    }

    @media (max-width: 600px) {
      .field-grid {
        grid-template-columns: 1fr;
      }
    }

    .form-field {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    label {
      font-size: 12px;
      font-weight: 500;
      color: #374151;
    }

    label span.hint {
      font-weight: 400;
      color: var(--text-muted);
      font-size: 11px;
    }

    input[type="date"],
    input[type="text"],
    textarea {
      border-radius: 10px;
      border: 1px solid #d1d5db;
      padding: 8px 10px;
      font-size: 13px;
      outline: none;
      transition: border-color 0.16s ease, box-shadow 0.16s ease, background 0.16s ease;
      background: #f9fafb;
      resize: vertical;
      min-height: 36px;
    }

    textarea {
      min-height: 70px;
      max-height: 130px;
    }

    input:focus,
    textarea:focus {
      border-color: var(--foch-blue);
      box-shadow: 0 0 0 1px rgba(0, 92, 153, 0.2);
      background: #ffffff;
    }

    .helper-text {
      font-size: 11px;
      color: var(--text-muted);
      margin-top: 2px;
    }

    .actions-row {
      margin-top: 14px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
    }

    .btn-primary {
      border: none;
      background: linear-gradient(135deg, var(--foch-blue), var(--foch-accent));
      color: white;
      padding: 8px 16px;
      border-radius: 999px;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      box-shadow: 0 10px 25px rgba(5, 101, 156, 0.45);
      transition: transform 0.14s ease, box-shadow 0.14s ease, opacity 0.1s ease;
      white-space: nowrap;
    }

    .btn-primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 14px 30px rgba(5, 101, 156, 0.55);
    }

    .btn-primary:active {
      transform: translateY(0);
      box-shadow: 0 6px 14px rgba(5, 101, 156, 0.35);
      opacity: 0.95;
    }

    .btn-primary[disabled] {
      opacity: 0.6;
      cursor: wait;
      box-shadow: none;
      transform: none;
    }

    .btn-secondary-text {
      border: none;
      background: transparent;
      color: var(--foch-blue);
      font-size: 11px;
      cursor: pointer;
      text-decoration: underline;
      text-underline-offset: 3px;
      padding: 0;
    }

    .status-area {
      font-size: 12px;
      min-height: 18px;
      color: var(--text-muted);
    }

    .status-area span {
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .status-area .dot {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: #9ca3af;
    }

    .status-area .success .dot {
      background: #16a34a;
    }

    .status-area .error .dot {
      background: var(--foch-danger);
    }

    .status-area .loading .dot {
      background: var(--foch-blue);
      animation: pulse 0.85s ease-in-out infinite alternate;
    }

    @keyframes pulse {
      from {
        transform: scale(0.9);
        opacity: 0.7;
      }
      to {
        transform: scale(1.2);
        opacity: 1;
      }
    }

    .hidden {
      display: none !important;
    }
  </style>
</head>
<body>
  <div class="app-shell">
    <!-- Bandeau marque / contexte -->
    <aside class="brand-panel">
      <div class="brand-header">
        <div class="brand-logo" aria-hidden="true">
          HF
        </div>
        <div class="brand-title-group">
          <span>H√îPITAL FOCH</span>
          <span>Indicateurs & Lettres de liaison</span>
        </div>
      </div>

      <p class="brand-subtitle">
        Interface de g√©n√©ration de rapports Excel sur les lettres de liaison,
        √† partir d‚Äôune p√©riode donn√©e ou d‚Äôune s√©lection de s√©jours.
      </p>

      <div class="brand-badges">
        <div class="brand-badge">
          <span class="brand-badge-dot"></span>
          <span>Qualit√© & Continuit√© des soins</span>
        </div>

      </div>

      <p class="brand-footer">
        Pour toute anomalie de donn√©es ou besoin d‚Äô√©volution, merci de contacter
        l'Unit√© Data de la DRCI. Cette interface ne contient aucune donn√©e
        patient nominative : seuls des indicateurs agr√©g√©s sont export√©s.
      </p>
    </aside>

    <!-- Panneau formulaires -->
    <main class="forms-panel">
      <div class="forms-header">
        <div>
          <div class="forms-title">G√©n√©ration de rapports</div>
          <div class="forms-subtitle">
            S√©lectionnez le mode de g√©n√©ration souhait√©.
          </div>
        </div>

        <div class="pill-switch" role="tablist">
          <button id="tab-by-date" class="active" type="button" role="tab">
            <span class="icon">üìÖ</span>
            <span>P√©riode</span>
          </button>
          <button id="tab-by-sejours" type="button" role="tab">
            <span class="icon">üõéÔ∏è</span>
            <span>S√©jours</span>
          </button>
        </div>
      </div>

      <!-- Formulaire par dates -->
      <section id="panel-by-date" class="card" role="tabpanel">
        <div class="card-header">
          <h2 class="card-title">Rapport par p√©riode</h2>
        </div>
        <p class="card-description">
          Renseignez une p√©riode de prise en charge. Un fichier Excel sera
          g√©n√©r√© et t√©l√©charg√© automatiquement avec les indicateurs de lettres
          de liaison.
        </p>

        <form id="form-by-date">
          <div class="field-grid">
            <div class="form-field">
              <label for="start-date">Date de d√©but</label>
              <input
                type="date"
                id="start-date"
                name="start-date"
                required
              />
            </div>
            <div class="form-field">
              <label for="end-date">Date de fin</label>
              <input type="date" id="end-date" name="end-date" required />
            </div>
          </div>

          <div class="form-field" style="margin-top: 10px;">
            <label for="sejour-list">
              Liste de s√©jours (optionnel)
              <span class="hint">‚Äì filtres suppl√©mentaires</span>
            </label>
            <textarea
              id="sejour-list"
              name="sejour-list"
              placeholder="Saisir des num√©ros de s√©jour s√©par√©s par des virgules ou des retours √† la ligne"
            ></textarea>
            <p class="helper-text">
              Si renseign√©, seuls les s√©jours indiqu√©s seront pris en compte
              dans la p√©riode s√©lectionn√©e.
            </p>
          </div>

          <div class="actions-row">
            <button type="submit" class="btn-primary" id="btn-date">
              <span>G√©n√©rer le rapport</span>
              <span>‚¨áÔ∏è</span>
            </button>
            <div class="status-area" id="status-date"></div>
          </div>
        </form>
      </section>

      <!-- Formulaire par s√©jours -->
      <section id="panel-by-sejours" class="card hidden" role="tabpanel">
        <div class="card-header">
          <h2 class="card-title">Rapport par s√©jours</h2>
        </div>
        <p class="card-description">
          Collez une liste de num√©ros de s√©jour. L‚ÄôAPI g√©n√®rera un rapport
          d√©di√© √† ces s√©jours uniquement.
        </p>

        <form id="form-by-sejours">
          <div class="form-field">
            <label for="sejour-ids">
              Num√©ros de s√©jour
            </label>
            <textarea
              id="sejour-ids"
              name="sejour-ids"
              required
              placeholder="Un num√©ro par ligne, ou s√©par√©s par des virgules"
            ></textarea>
            <p class="helper-text">
              Exemple : 2024001234, 2024005678, 2024012345
            </p>
          </div>

          <div class="actions-row">
            <button type="submit" class="btn-primary" id="btn-sejours">
              <span>G√©n√©rer le rapport</span>
              <span>‚¨áÔ∏è</span>
            </button>
            <div class="status-area" id="status-sejours"></div>
          </div>
        </form>
      </section>
    </main>
  </div>

  <script>
    // --- Helpers DOM ---
    const byDateTab = document.getElementById("tab-by-date");
    const bySejoursTab = document.getElementById("tab-by-sejours");
    const panelByDate = document.getElementById("panel-by-date");
    const panelBySejours = document.getElementById("panel-by-sejours");
    const statusDate = document.getElementById("status-date");
    const statusSejours = document.getElementById("status-sejours");
    const btnDate = document.getElementById("btn-date");
    const btnSejours = document.getElementById("btn-sejours");

    function setStatus(element, type, message) {
      if (!element) return;
      if (!message) {
        element.textContent = "";
        return;
      }

      let cls = "";
      if (type === "success") cls = "success";
      else if (type === "error") cls = "error";
      else if (type === "loading") cls = "loading";

      element.innerHTML =
        '<span class="' +
        cls +
        '"><span class="dot"></span><span>' +
        message +
        "</span></span>";
    }

    function parseSejourList(raw) {
      if (!raw) return [];
      return raw
        .split(/[\n,;]+/)
        .map((s) => s.trim())
        .filter((s) => s.length > 0);
    }

    // --- Navigation entre les 2 modes ---
    byDateTab.addEventListener("click", () => {
      byDateTab.classList.add("active");
      bySejoursTab.classList.remove("active");
      panelByDate.classList.remove("hidden");
      panelBySejours.classList.add("hidden");
    });

    bySejoursTab.addEventListener("click", () => {
      bySejoursTab.classList.add("active");
      byDateTab.classList.remove("active");
      panelBySejours.classList.remove("hidden");
      panelByDate.classList.add("hidden");
    });

    // --- Soumission "par date" ---
    document
      .getElementById("form-by-date")
      .addEventListener("submit", async (e) => {
        e.preventDefault();
        setStatus(statusDate, "loading", "G√©n√©ration du rapport en cours‚Ä¶");
        btnDate.disabled = true;

        const startDate = document.getElementById("start-date").value;
        const endDate = document.getElementById("end-date").value;
        const sejourRaw = document.getElementById("sejour-list").value;
        const sejourList = parseSejourList(sejourRaw);

        if (!startDate || !endDate) {
          setStatus(statusDate, "error", "Veuillez renseigner les deux dates.");
          btnDate.disabled = false;
          return;
        }

        try {
          const response = await fetch("/api/report/by-date", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              start_date: startDate,
              end_date: endDate,
              sejour_list: sejourList.length ? sejourList : null,
            }),
          });

          if (!response.ok) {
            let msg = "Erreur lors de la g√©n√©ration du rapport.";
            try {
              const data = await response.json();
              if (data && data.detail) msg = data.detail;
            } catch (_) {}
            setStatus(statusDate, "error", msg);
          } else {
            const blob = await response.blob();
            const disposition = response.headers.get("Content-Disposition");
            let filename = "rapport_lettres_liaison.xlsx";

            if (disposition && disposition.includes("filename=")) {
              const match = disposition.match(/filename=\"?([^\";]+)\"?/);
              if (match && match[1]) {
                filename = match[1];
              }
            }

            const url = window.URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            a.remove();
            window.URL.revokeObjectURL(url);

            setStatus(statusDate, "success", "Rapport g√©n√©r√© et t√©l√©charg√©.");
          }
        } catch (err) {
          console.error(err);
          setStatus(
            statusDate,
            "error",
            "Une erreur technique est survenue. Veuillez r√©essayer."
          );
        } finally {
          btnDate.disabled = false;
        }
      });

    // --- Soumission "par s√©jours" ---
    document
      .getElementById("form-by-sejours")
      .addEventListener("submit", async (e) => {
        e.preventDefault();
        setStatus(
          statusSejours,
          "loading",
          "G√©n√©ration du rapport pour les s√©jours s√©lectionn√©s‚Ä¶"
        );
        btnSejours.disabled = true;

        const raw = document.getElementById("sejour-ids").value;
        const sejourIds = parseSejourList(raw);

        if (!sejourIds.length) {
          setStatus(
            statusSejours,
            "error",
            "Veuillez saisir au moins un num√©ro de s√©jour."
          );
          btnSejours.disabled = false;
          return;
        }

        try {
          const response = await fetch("/api/report/by-sejours", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              sejour_ids: sejourIds,
            }),
          });

          if (!response.ok) {
            let msg = "Erreur lors de la g√©n√©ration du rapport.";
            try {
              const data = await response.json();
              if (data && data.detail) msg = data.detail;
            } catch (_) {}
            setStatus(statusSejours, "error", msg);
          } else {
            const blob = await response.blob();
            const disposition = response.headers.get("Content-Disposition");
            let filename = "rapport_lettres_liaison_sejours.xlsx";

            if (disposition && disposition.includes("filename=")) {
              const match = disposition.match(/filename=\"?([^\";]+)\"?/);
              if (match && match[1]) {
                filename = match[1];
              }
            }

            const url = window.URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            a.remove();
            window.URL.revokeObjectURL(url);

            setStatus(
              statusSejours,
              "success",
              "Rapport g√©n√©r√© et t√©l√©charg√©."
            );
          }
        } catch (err) {
          console.error(err);
          setStatus(
            statusSejours,
            "error",
            "Une erreur technique est survenue. Veuillez r√©essayer."
          );
        } finally {
          btnSejours.disabled = false;
        }
      });
  </script>
</body>
</html>
