name: CI/CD

on:
  push:
    branches:
      - main

jobs:
  build-and-push:
    runs-on: self-hosted
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        
      - name: Debug Docker (CRITIQUE)
        run: |
          echo "=== UTILISATEUR ==="
          whoami
          id
          
          echo "=== DOCKER INFO ==="
          docker context ls
          docker info | grep -A 10 "Insecure Registries" || true
          
          echo "=== DOCKER CONFIG USER ==="
          ls -la ~/.docker/ || echo "Pas de .docker"
          
          echo "=== DAEMON.JSON ==="
          sudo cat /etc/docker/daemon.json || echo "Pas de daemon.json"


      - name: Build image
        run: |
          docker build -t 10.2.240.5:8080/production/api-iqss:${{ github.sha }} .
          docker tag 10.2.240.5:8080/production/api-iqss:${{ github.sha }} \
            10.2.240.5:8080/production/api-iqss:latest

      - name: Push image
        run: |
          docker push 10.2.240.5:8080/production/api-iqss:${{ github.sha }}
          docker push 10.2.240.5:8080/production/api-iqss:latest
